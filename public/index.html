<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirDrop Web</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f0f13; color: white; text-align: center; padding: 20px; }
        
        /* Debug Info */
        .debug-info { background: #1c1c21; color: #888; padding: 10px; font-size: 12px; border-radius: 8px; display: inline-block; margin-bottom: 20px; border: 1px solid #333; }
        .highlight { color: #00d2ff; font-weight: bold; }

        .radar-area { min-height: 250px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        
        .device {
            width: 100px; height: 100px; background: #2b2b36; border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .device:hover { border-color: #00d2ff; background: #353542; }
        .device svg { width: 40px; height: 40px; fill: #eee; margin-bottom: 5px; }
        
        .searching { color: #555; font-style: italic; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <h2>ðŸš€ Shared Network</h2>
    
    <div class="debug-info">
        My IP (Room ID): <span id="my-ip" class="highlight">Connecting...</span>
    </div>

    <div class="radar-area" id="radar">
        <div class="searching" id="scan-msg">Looking for devices on same IP...</div>
    </div>

    <input type="file" id="fileInput">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    
    <script>
        const socket = io();
        const radar = document.getElementById('radar');
        const scanMsg = document.getElementById('scan-msg');
        const fileInput = document.getElementById('fileInput');
        const ipDisplay = document.getElementById('my-ip');
        
        let peers = {};
        let targetId = null;

        // 1. Show the IP the server sees
        socket.on('your-ip', (ip) => {
            ipDisplay.innerText = ip;
        });

        // 2. Peer Logic
        function addPeerUI(id) {
            scanMsg.style.display = 'none';
            if(document.getElementById(id)) return;

            const div = document.createElement('div');
            div.className = 'device';
            div.id = id;
            div.innerHTML = `
                <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                <span>User</span>
            `;
            div.onclick = () => { targetId = id; fileInput.click(); };
            radar.appendChild(div);
        }

        socket.on('peer-joined', data => addPeerUI(data.id));
        socket.on('peers-existing', users => users.forEach(addPeerUI));
        socket.on('peer-left', id => {
            const el = document.getElementById(id);
            if(el) el.remove();
            if(radar.children.length <= 1) scanMsg.style.display = 'block';
        });

        // 3. File Transfer Logic (Same as before)
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (!file || !targetId) return;

            const p = new SimplePeer({ initiator: true, trickle: false });
            p.on('signal', data => socket.emit('signal', { target: targetId, signal: data }));
            p.on('connect', () => {
                p.send(JSON.stringify({ name: file.name, size: file.size }));
                p.send(file);
            });
            peers[targetId] = p;
        });

        socket.on('signal', data => {
            if(!peers[data.sender]) {
                const p = new SimplePeer({ initiator: false, trickle: false });
                p.on('signal', signal => socket.emit('signal', { target: data.sender, signal: signal }));
                p.on('data', chunk => {
                    try {
                        const meta = JSON.parse(new TextDecoder().decode(chunk));
                        if(meta.name) return;
                    } catch(e) {}
                    const blob = new Blob([chunk]);
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = "received_file";
                    document.body.appendChild(link);
                    link.click();
                });
                peers[data.sender] = p;
            }
            peers[data.sender].signal(data.signal);
        });
    </script>
</body>
</html>
