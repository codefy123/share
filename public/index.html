<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropShare | Secure P2P</title>
    <style>
        /* RESET & VERCEL THEME */
        :root {
            --bg: #000000;
            --card-bg: #111111;
            --border: #333333;
            --text-main: #ffffff;
            --text-dim: #888888;
            --accent: #ffffff; 
            --accent-text: #000000;
            --error: #ff4d4f;
            --success: #00b96b;
        }
        
        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text-main); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* LAYOUT */
        .container { width: 100%; max-width: 480px; padding: 20px; box-sizing: border-box; margin-top: 40px; }
        .header { margin-bottom: 40px; text-align: center; }
        .header h1 { font-size: 24px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        .header p { color: var(--text-dim); font-size: 14px; margin-top: 8px; }

        /* CARDS */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-bottom: 20px; transition: border-color 0.2s; }
        .card:hover { border-color: #555; }
        
        .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 12px; display: block; }

        /* MY CODE DISPLAY */
        .code-display { font-size: 32px; font-weight: 700; letter-spacing: 2px; font-family: 'Courier New', monospace; display: flex; justify-content: space-between; align-items: center; }
        .copy-btn { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 5px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { color: var(--text-main); border-color: var(--text-main); }

        /* INPUTS (Fixing the scroll issue) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        input { background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; font-size: 16px; width: 100%; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--accent); }
        
        button.primary { background: var(--accent); color: var(--accent-text); border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; }
        button.primary:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* STATUS */
        .status-area { min-height: 20px; font-size: 14px; text-align: center; margin-top: 10px; }
        .error-msg { color: var(--error); }
        .success-msg { color: var(--success); }

        /* FILE DROP ZONE (Hidden until connected) */
        #drop-zone { display: none; margin-top: 20px; border: 2px dashed var(--border); padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; }
        #drop-zone:hover { border-color: var(--accent); background: #0a0a0a; }
        #drop-zone p { pointer-events: none; color: var(--text-dim); }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>DropShare</h1>
            <p>Secure, peer-to-peer file transfer. No limits.</p>
        </div>

        <div class="card">
            <span class="label">Your Secure Code</span>
            <div class="code-display">
                <span id="my-code">...</span>
                <button class="copy-btn" onclick="copyCode()">COPY</button>
            </div>
        </div>

        <div class="card">
            <span class="label">Connect to Peer</span>
            <div class="input-group">
                <input type="number" id="target-code" placeholder="Enter 6-digit code">
                <button class="primary" id="connect-btn" onclick="connectManual()">Connect</button>
            </div>
            <div class="status-area" id="status-msg"></div>
        </div>

        <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
            <p>ðŸ“‚ <strong>Click to Upload</strong> or Drag & Drop</p>
            <div id="transfer-status" style="margin-top:10px; color:white; font-size:12px;"></div>
        </div>
        
        <input type="file" id="fileInput" style="display:none">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>

    <script>
        const socket = io();
        let myCode = null;
        let peer = null;
        let targetId = null;

        const statusMsg = document.getElementById('status-msg');
        const connectBtn = document.getElementById('connect-btn');
        const dropZone = document.getElementById('drop-zone');
        const transferStatus = document.getElementById('transfer-status');

        // 1. Initialization
        socket.on('init-info', (data) => {
            myCode = data.code;
            document.getElementById('my-code').innerText = myCode;
        });

        socket.on('error-msg', (msg) => {
            statusMsg.innerText = msg;
            statusMsg.className = "status-area error-msg";
            connectBtn.disabled = false;
            connectBtn.innerText = "Connect";
        });

        // 2. Connect Button Logic
        function connectManual() {
            const code = document.getElementById('target-code').value;
            
            // VALIDATION
            if (!code) return showError("Please enter a code.");
            if (code === myCode) return showError("You cannot connect to yourself.");
            if (code.length < 6) return showError("Code must be 6 digits.");

            // UI UPDATE
            connectBtn.disabled = true;
            connectBtn.innerText = "Joining...";
            statusMsg.innerText = "";

            // SEND REQUEST
            socket.emit('join-manual', code);
        }

        // 3. Handshake Logic (The Host starts the call)
        socket.on('request-connection', (data) => {
            // Someone entered MY code. I will be the Initiator.
            statusMsg.innerText = "Incoming connection...";
            initializePeer(data.requesterId, true);
        });

        // The Joiner receives the signal and responds
        socket.on('signal', (data) => {
            if (!peer) {
                initializePeer(data.sender, false);
            }
            peer.signal(data.signal);
        });

        // 4. WebRTC Core
        function initializePeer(partnerId, initiator) {
            targetId = partnerId;
            
            peer = new SimplePeer({
                initiator: initiator,
                trickle: false 
            });

            peer.on('signal', data => {
                socket.emit('signal', { target: partnerId, signal: data });
            });

            peer.on('connect', () => {
                statusMsg.innerText = "Connected Securely.";
                statusMsg.className = "status-area success-msg";
                connectBtn.innerText = "Connected";
                dropZone.style.display = "block"; // Show Upload Area
            });

            peer.on('data', data => {
                // FILE RECEIVING LOGIC
                try {
                    const meta = JSON.parse(new TextDecoder().decode(data));
                    if(meta.name) {
                        transferStatus.innerText = `Receiving ${meta.name}...`;
                        return;
                    }
                } catch(e) {}

                const blob = new Blob([data]);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "DropShare_File_" + Date.now();
                document.body.appendChild(a);
                a.click();
                transferStatus.innerText = "âœ… File Downloaded!";
            });
            
            peer.on('error', err => {
                console.error(err);
                showError("Connection failed. Try again.");
                connectBtn.disabled = false;
            });
        }

        // 5. File Sending
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !peer) return;

            transferStatus.innerText = `Sending ${file.name}...`;
            
            // Send Metadata first
            peer.send(JSON.stringify({ name: file.name, size: file.size }));
            
            // Send File
            const reader = new FileReader();
            reader.onload = () => {
                peer.send(reader.result);
                transferStatus.innerText = "âœ… File Sent!";
            };
            reader.readAsArrayBuffer(file);
        });

        // Helpers
        function showError(msg) {
            statusMsg.innerText = msg;
            statusMsg.className = "status-area error-msg";
        }

        function copyCode() {
            navigator.clipboard.writeText(myCode);
            alert("Code Copied!");
        }
    </script>
</body>
</html>
